<!DOCTYPE html>
<html>
<head>
  <title>USYD Meta Lab</title>
  <link rel="icon" type="image/x-icon" href="https://usyd-meta-lab.github.io/favicon-32x32.png">

  <!-- Load jsPsych and dependencies -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.min.js"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/jquery-ui-css@1.11.5/jquery-ui.css" rel="stylesheet" type="text/css" />

  <!-- Load jsPsych plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-external-html@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-browser-check@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Load the global environment and additional scripts -->
  <script src="https://usyd-meta-lab.github.io/files/info_sheets.js"></script>



  <!-- Custom CSS -->
  <link href="custom-css.css" rel="stylesheet" type="text/css" />


</head>

<body></body>

<script>






/* 
  ===============================================================
  =              GLOBAL SETTINGS & INITIALIZATION               =
  ===============================================================
*/

// Initialize jsPsych
  const jsPsych = initJsPsych({
    on_interaction_data_update: function(data) {
    // If participant exits fullscreen, note it (unless it's a pilot).
      if (data.event === 'fullscreenexit' && pilot !== 'true') {
        in_fullscreen = false;
      }
    },
    on_finish: function(data) {
    // If user is forced to abort (wrong browser or device), show alert
      if (aborted === true) {
        alert("You must use Chrome or Firefox to complete this experiment.");
      }


      if (aborted === false) {

      // If not aborted, first save total time and then check average accuracy from summary trials
        var start_time = jsPsych.getStartTime();
        jsPsych.data.addProperties({ start_time: start_time });
        var total_time = jsPsych.getTotalTime();
        jsPsych.data.addProperties({ total_time: total_time });


      // Turn on to save a local copy
      //jsPsych.data.get().localSave('csv','mydata.csv'); 
        window.location = redirect_link;
        
      }
    }
  });

/**
 * These variables can be modified as needed:
 * - DataPipe_ID:         The DataPipe ID to which the data will be saved.
 * - SONA/prolific info:  Used for setting up redirect links.
 * - Task parameters:     Number of trials, blocks etc.
 */
const DataPipe_ID = "vmuVgxxOMTlT";  // The DataPipe ID for where the data should be stored
const sona_experiment_id = "NA";      // The SONA experiment ID 
const sona_credit_token = "NA";       // The SONA credit token 
const Prolific_redirect = "CHGWKNI0"; // The Prolific redirect link (to credit)
const Prolific_failed_check = "C13PIUOF"; // The Prolific redirect link for failing an attention check
const task_time = 30; // (minutes) for the PIS



// Task parameters: 
let in_fullscreen = true;   // Tracks whether participant is in fullscreen
let trialnum = 1;           // Trial counter
let blocknum = 1;           // Block counter
let aborted = false;        // Whether user was aborted from experiment



// Below loads the EI task (it needs to be loaded after jsPsych is inialised)
</script>
<script src="PAQ.js"></script>
<script>


/* 
  ===============================================================
  =                        INSTRUCTIONS                          =
  ===============================================================
*/

/**
 * Instructions displayed before practice trials begin.
 * Will depend on whether confidence ratings are turned on or off.
 */
const instructions = {
  type: jsPsychInstructions,
  pages: [
    `<h2>Welcome to the task!</h2>
         <p class="instructions">In this task, you will judge which of two images contains more dots, then rate your confidence in your judgment.</p>
         <p class="instructions">A black cross will appear first; focus on it. Two boxes with a certain number of white dots will flash. Then, choose which box had more dots.</p>
         <p class="instructions"><strong>Press W</strong> if the <strong>left</strong> box had more dots, or <strong>E</strong> if the <strong>right</strong> box had more dots.</p>
         <p class="instructions">You will then rate your confidence in that judgment using a scale.</p>
    <p class="instructions">Use the entire scale from &apos;Guessing&apos; to &apos;Certain.&apos;</p>`,

    `<p class="instructions">Let&#39;s do some practice trials. Respond only after the dots have disappeared.</p>
         <p class="instructions">During practice, you will see feedback indicating <font color="green">correct</font> or <font color="red">incorrect</font> judgments.</p>
    <p class="instructions">No confidence rating is needed during these practice trials.</p>`
  ],
  show_clickable_nav: true
};


/**
 * Instructions about confidence scale appear only if confidence ratings are on.
 */

const conf_instruc = {
  timeline: [
        // First Screen
    {
     type: jsPsychHtmlSliderResponse,
     stimulus: `A rating scale as shown below is used throughout the task. 
        You will select any point with your mouse.<br>Choose any point on the 
          scale and click &apos;Submit&apos; to continue.<br><br>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
     <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
     min: 1,
     max: 6,
     step: 1,
     slider_width: 800,
     require_movement: true,
     labels: ['Guessing', '', '', '', '', 'Certain'],
     button_label: "Submit",
     on_finish: function(data) {
      data.trial_type = "Confidence Rating";
    },
    css_classes: ["conf_rating"],
    on_load: function() {
            // Center the slider by calculating the left margin.
      const w = window.innerWidth;
      const marLeft = (w - 800) / 2 + "px";
      document.getElementById("conf1").style.left = marLeft;
      document.getElementById("conf2").style.left = marLeft;
      document.getElementById("conf3").style.left = marLeft;
      document.getElementById("conf4").style.left = marLeft;
      document.getElementById("conf5").style.left = marLeft;
    }
  },

       // Second Screen
  {
   type: jsPsychHtmlSliderResponse,
   stimulus: `During the task, if you are <strong>very sure</strong> that you made the correct judgement, you should respond <strong>&apos;Certain&apos;</strong><br><br>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
   <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
   min: 1,
   max: 6,
   step: 1,
   slider_width: 800,
   require_movement: false,
   labels: ['Guessing', '', '', '', '', 'Certain'],
   button_label: "Continue",
   on_finish: function(data) {
    data.trial_type = "Confidence Rating";
  },
  css_classes: ["conf_rating"],
  on_load: function() {
    document.querySelector('input[type=range]').disabled = true;
            // Center the slider by calculating the left margin.
    const w = window.innerWidth;
    const marLeft = (w - 800) / 2 + "px";
    document.getElementById("conf1").style.left = marLeft;
    document.getElementById("conf2").style.left = marLeft;
    document.getElementById("conf3").style.left = marLeft;
    document.getElementById("conf4").style.left = marLeft;
    document.getElementById("conf5").style.left = marLeft;
  }
},

// Third Screen
{
 type: jsPsychHtmlSliderResponse,
 stimulus: `If you are <strong>very unsure</strong> you made the correct judgement, you should respond <strong>&apos;Guessing&apos;</strong><br><br>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
 <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
 min: 1,
 max: 6,
 step: 1,
 slider_width: 800,
 slider_start: 1,
 require_movement: false,
 labels: ['Guessing', '', '', '', '', 'Certain'],
 button_label: "Continue",
 on_finish: function(data) {
  data.trial_type = "Confidence Rating";
},
css_classes: ["conf_rating"],
on_load: function() {
  document.querySelector('input[type=range]').disabled = true;
            // Center the slider by calculating the left margin.
  const w = window.innerWidth;
  const marLeft = (w - 800) / 2 + "px";
  document.getElementById("conf1").style.left = marLeft;
  document.getElementById("conf2").style.left = marLeft;
  document.getElementById("conf3").style.left = marLeft;
  document.getElementById("conf4").style.left = marLeft;
  document.getElementById("conf5").style.left = marLeft;
}
},


// Fourth Screen
{
 type: jsPsychHtmlSliderResponse,
 stimulus: `If you are <strong>somewhat sure</strong> about being correct, you should select a rating between the two descriptions.<br><br>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
 <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
 min: 1,
 max: 7,
 step: 1,
 slider_width: 800,
 slider_start: 4,
 require_movement: false,
 labels: ['Guessing', '', '', '', '', 'Certain'],
 button_label: "Continue",
 on_finish: function(data) {
  data.trial_type = "Confidence Rating";
},
css_classes: ["conf_rating"],
on_load: function() {
  document.querySelector('input[type=range]').disabled = true;
            // Center the slider by calculating the left margin.
  const w = window.innerWidth;
  const marLeft = (w - 800) / 2 + "px";
  document.getElementById("conf1").style.left = marLeft;
  document.getElementById("conf2").style.left = marLeft;
  document.getElementById("conf3").style.left = marLeft;
  document.getElementById("conf4").style.left = marLeft;
  document.getElementById("conf5").style.left = marLeft;
}
},

       // Fifth Screen
{
 type: jsPsychHtmlSliderResponse,
 stimulus: `If you understand how to use and take advantage of the whole rating scale, choose any point on the rating scale and click &apos;Submit&apos; to continue.<br><br>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
 <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
 min: 1,
 max: 6,
 step: 1,
 slider_width: 800,
 require_movement: true,
 labels: ['Guessing', '', '', '', '', 'Certain'],
 button_label: "Submit",
 on_finish: function(data) {
  data.trial_type = "Confidence Rating";
},
css_classes: ["conf_rating"],
on_load: function() {
            // Center the slider by calculating the left margin.
  const w = window.innerWidth;
  const marLeft = (w - 800) / 2 + "px";
  document.getElementById("conf1").style.left = marLeft;
  document.getElementById("conf2").style.left = marLeft;
  document.getElementById("conf3").style.left = marLeft;
  document.getElementById("conf4").style.left = marLeft;
  document.getElementById("conf5").style.left = marLeft;
}
},

]
}





/* 
  ===============================================================
  =                 BROWSER & FULLSCREEN CHECKS                 =
  ===============================================================
*/

// Check that participant is using Chrome or Firefox on a desktop
const browser_check = {
  timeline: [
    {
      type: jsPsychBrowserCheck,
      inclusion_function: (data) => {
        // Accept only if browser is Chrome or Firefox and not on mobile
        return ['chrome', 'firefox'].includes(data.browser) && data.mobile === false;
      },
      exclusion_message: (data) => {
        aborted = true;
        if (data.mobile) {
          return '<p>You must use a desktop/laptop computer to participate in this experiment.</p>';
        } else if (!['chrome','firefox'].includes(data.browser)) {
          return '<p>You must use Chrome or Firefox as your browser to complete this experiment.</p>';
        }
      }
    }
  ],
  conditional_function: function() {
    // Skip this check if pilot mode
    if (pilot === 'true') {
      return false;
    } 
    return true;
  }
};

// Request participant enter fullscreen
const enter_fullscreen = {
  timeline: [
    {
      type: jsPsychFullscreen,
      message: '<p>To take part in the experiment, your browser must be in fullscreen mode. Exiting fullscreen mode will pause the experiment.<br><br>Please click the button below to enable fullscreen and continue.</p>',
      fullscreen_mode: true,
      on_finish: function(){
        in_fullscreen = true;
      }
    }
  ],
  conditional_function: function() {
    // Skip if pilot
    if (pilot === 'true') {
      return false;
    } 
    return true;
  }
};

/* 
  ===============================================================
  =                     Emotion TRIAL PROCEDURE                      =
  ===============================================================
*/


/**
 * Defines the dot trial timeline for the task.
 *
 * This timeline includes:
 *   1. A fixation cross trial.
 *   2. A brief stimulus presentation trial that shows two boxes with dots.
 *   3. A stimulus response trial where the participant indicates which side has more dots.
 *   4. A feedback trial that highlights the selected response with an outline (blue, green, or red).
 *   5. A confidence rating trial where participants rate how confident they were in their response (conditionally displayed).
 *   6. A summary trial that logs the trial data and updates the staircase parameters.
 *
 * External variables referenced in this timeline include:
 *   - `staircase`: An object that holds the current staircase information including `current_log` and `consecutive_correct`.
 *   - `phase`: A variable indicating the current phase (e.g., "Test" or "Practice").
 *   - `trialnum`: A counter for the current trial number.
 *   - `provide_feedback`: A flag that indicates whether feedback should be provided.
 */
var emotion_trial = {
  timeline: [
    // 1. Fixation cross trial
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p style="font-size: 70pt;">+</p>',
      choices: "NO_KEYS",
      trial_duration: 1000
    },

    // 2. Stimulus presentation (brief)
    {
      type: jsPsychImageButtonResponse,
      stimulus: jsPsych.timelineVariable('stimuli'),
      choices: ["Yes", "No"],
      on_finish: function(data) {
        data.trial_type = "Stimulus Response";
      }
    },


    // 3. Confidence Rating trial (conditional)
    {
      timeline: [
        {
          type: jsPsychHtmlSliderResponse,
          stimulus: `<h3>Rate your confidence:</h3>
            <div id="conf1" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:15px;"></div>
            <div id="conf2" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:169px;"></div>
            <div id="conf3" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:323px;"></div>
            <div id="conf4" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:477px;"></div>
          <div id="conf5" class="conf" style="height:25px; width:154px; margin-top:2px; margin-left:631px;"></div>`,
          min: 1,
          max: 6,
          step: 1,
          slider_width: 800,
          require_movement: true,
          labels: ['Guessing', '', '', '', '', 'Certain'],
          button_label: "Submit",
          on_finish: function(data) {
            data.trial_type = "Confidence Rating";
          },
          css_classes: ["conf_rating"],
          on_load: function() {
            // Center the slider by calculating the left margin.
            const w = window.innerWidth;
            const marLeft = (w - 800) / 2 + "px";
            document.getElementById("conf1").style.left = marLeft;
            document.getElementById("conf2").style.left = marLeft;
            document.getElementById("conf3").style.left = marLeft;
            document.getElementById("conf4").style.left = marLeft;
            document.getElementById("conf5").style.left = marLeft;
          }
        }
      ]
    },

    // 4. Summary trial: Stores data and updates the staircase.
    {
      type: jsPsychCallFunction,
      /**
       * Updates the staircase following a two-down one-up rule based on response accuracy
       * and logs relevant trial data. The step size decreases with increasing trial numbers.
       */
      func: function() {
      },
      on_finish: function(data) {
        // Log the reaction time and associate the stimulus response data with the summary trial.
        const lastResp = jsPsych.data.get().filter({trial_type: "Stimulus Response"}).last(1).values()[0];
        data.rt         = lastResp.rt;
        data.response   = lastResp.response;
        const lastConf = jsPsych.data.get().filter({trial_type: "Confidence Rating"}).last(1).values()[0];
        data.confidence = lastConf.response;

        data.trial_type = "Summary Trial";
        trialnum++;  // Increment the trial number.
      }
    }
  ],
  timeline_variables: [
    {stimuli: true},
    {stimuli: false},
  ],
  randomize_order: true
};







/* 
  ===============================================================
  =                    FINAL DEBRIEF & SAVE                     =
  ===============================================================
*/

// Optional debug question: Issues encountered?
const debug = {
  type: jsPsychSurveyText,
  questions: [
    {prompt: 'Did you experience any issues while completing this study?', rows: 5}
  ]
};

// Capture URL parameters (Prolific, SONA, pilot, etc.)
const PROLIFIC_PID = jsPsych.data.getURLVariable('PROLIFIC_PID');
const SONAID       = jsPsych.data.getURLVariable('SONAID');
const pilot        = jsPsych.data.getURLVariable('pilot');

// Decide how to redirect user depending on whether they're from SONA or Prolific
let redirect_link, attention_redirect_link;

if (typeof SONAID !== 'undefined') {
  // SONA
  jsPsych.data.addProperties({ participant_id: SONAID, Source: "SONA" });
  redirect_link = `https://sydneypsych.sona-systems.com/webstudy_credit.aspx?experiment_id=${sona_experiment_id}&credit_token=${sona_credit_token}&survey_code=${SONAID}&id=${SONAID}`;
  attention_redirect_link = `https://sydney.au1.qualtrics.com/jfe/form/SV_3h2qh8pBAnv00QK?SONAID=${SONAID}&accuracy=`;
} else {
  // Prolific
  jsPsych.data.addProperties({ participant_id: PROLIFIC_PID, Source: "Prolific" });
  redirect_link = `https://app.prolific.com/submissions/complete?cc=${Prolific_redirect}`;
  attention_redirect_link = `https://app.prolific.co/submissions/complete?cc=${Prolific_failed_check}`;
}

// Filename and location to save data
const subject_id = jsPsych.randomization.randomID(10);
const filename   = `participant-${subject_id}_data.csv`;

// We use jsPsychPipe to save to OSF (or another DataPipe-supported platform)
const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: DataPipe_ID,
  filename: filename,
  data_string: () => jsPsych.data.get().csv()
};





/* 
  ===============================================================
  =                 BUILD AND RUN THE EXPERIMENT                =
  ===============================================================
*/

/**
 * Full timeline for Condition 1. 
 * (You can create separate timelines/conditions if desired.)
 */
const condition_1_timeline = [
  PAQ,
  browser_check,
  enter_fullscreen,
  participant_info_paid,  // from info_sheets.js 
  participant_info_SONA,  // from info_sheets.js
  demographics,           // from info_sheets.js
  instructions,
  PAQ,
  emotion_trial,
  debug,
  save_data,
  DEBRIEF_SONA   
];



/**
 * Asynchronously fetches a 'condition' from DataPipe (if needed),
 * then runs the corresponding timeline. If you do not use multiple
 * conditions, you could simply run condition_1_timeline directly.
 */
async function createExperiment() {
  const condition = await jsPsychPipe.getCondition(DataPipe_ID);
  jsPsych.data.addProperties({ condition: condition });

  // If you have different conditions, you could add them here:
  if (condition == 0) {
    jsPsych.run(condition_1_timeline);
  } else {
    // Default fallback
    jsPsych.run(condition_1_timeline);
  }


}

// Start the experiment
createExperiment();

</script>
</html>
